<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½å‹å…±äº«è¨˜å¸³</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 20px; }
        .card { border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: none; }
        .history-box { display: none; margin-top: 20px; }
        .amount-plus { color: #198754; font-weight: bold; }
        .amount-minus { color: #dc3545; font-weight: bold; }
        .loading-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999; text-align: center; padding-top: 200px;
        }
    </style>
</head>
<body>

<div class="container" style="max-width: 600px;">
    
    <div class="text-center mb-4">
        <h3>ğŸ’° Netflix / Spotify å„²å€¼</h3>
        <p class="text-muted">è‡ªå‹•è¨˜å¸³èˆ‡é¤˜é¡æŸ¥è©¢</p>
    </div>

    <div class="card p-4">
        <form id="accountingForm">
            
            <div class="mb-3">
                <label class="form-label">æˆ‘æ˜¯èª°ï¼Ÿ</label>
                <select class="form-select" id="name" required>
                    <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">åŒ¯æ¬¾æ—¥æœŸ</label>
                <input type="date" class="form-control" id="date" required>
            </div>

            <div class="mb-3">
                <label class="form-label">é …ç›®</label>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="type" id="spotify" value="Spotify" checked>
                        <label class="form-check-label" for="spotify">Spotify</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="type" id="netflix" value="Netflix">
                        <label class="form-check-label" for="netflix">Netflix</label>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">é‡‘é¡ (TWD)</label>
                <input type="number" class="form-control" id="amount" placeholder="ä¾‹å¦‚ï¼š940" required>
            </div>

            <div class="mb-3">
                <label class="form-label">å‚™è¨» / å¸³è™Ÿå¾Œäº”ç¢¼</label>
                <input type="text" class="form-control" id="last5" placeholder="ä¾‹å¦‚ï¼š12345" required>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg">ç¢ºèªé€å‡º</button>
            </div>
        </form>
    </div>

    <div id="resultArea" class="history-box card p-4">
        <h4 class="text-center mb-3" id="resultTitle">æŸ¥è©¢çµæœ</h4>
        <div class="text-center mb-4">
            <span class="text-muted">ç›®å‰é¤˜é¡</span>
            <h2 id="currentBalance"></h2>
        </div>
        
        <h6>æœ€è¿‘ 5 ç­†ç´€éŒ„ï¼š</h6>
        <ul class="list-group list-group-flush" id="historyList">
            </ul>
    </div>
</div>

<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2 fw-bold">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
</div>

<script>
    // â˜…â˜…â˜…â˜…â˜… è«‹å°‡ä¸‹é¢é€™è¡Œç¶²å€æ›æˆä½ çš„ GAS éƒ¨ç½²ç¶²å€ â˜…â˜…â˜…â˜…â˜…
    const API_URL = "https://script.google.com/macros/s/AKfycbyz8ZLjChD-_KnMTPWZ3NepN8sDFioFldzquGvWpdyR7jXn3YnoI7peBl3K2UglrTf8/exec"; 
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

    // 1. ç¶²é é–‹å•Ÿæ™‚åšçš„äº‹
    window.onload = function() {
        document.getElementById('date').valueAsDate = new Date(); // é è¨­ä»Šå¤©
        fetchMembers(); // æŠ“å–æˆå“¡åå–®
    };

    // 2. æŠ“å–æˆå“¡åå–®
    function fetchMembers() {
        fetch(API_URL + "?action=getMembers")
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('name');
                select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ä½ çš„åå­—</option>';
                data.members.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.innerText = m;
                    select.appendChild(opt);
                });
            })
            .catch(err => alert("ç„¡æ³•è¼‰å…¥åå–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€è¨­å®š"));
    }

    // 3. è¡¨å–®é€å‡ºäº‹ä»¶
    document.getElementById('accountingForm').addEventListener('submit', function(e) {
        e.preventDefault(); // é˜»æ­¢é é¢è·³è½‰
        
        const loading = document.getElementById('loading');
        loading.style.display = 'block'; // é¡¯ç¤ºè½‰åœˆåœˆ

        // æ”¶é›†è³‡æ–™
        const formData = {
            name: document.getElementById('name').value,
            date: document.getElementById('date').value,
            type: document.querySelector('input[name="type"]:checked').value,
            amount: document.getElementById('amount').value,
            last5: document.getElementById('last5').value
        };

        // ä½¿ç”¨ POST å‚³é€è³‡æ–™åˆ° Google Sheet
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(formData)
        })
        .then(res => res.json())
        .then(data => {
            loading.style.display = 'none'; // éš±è—è½‰åœˆåœˆ
            
            if (data.status === 'success') {
                showResult(data.data);
                // æ¸…ç©ºé‡‘é¡å’Œå‚™è¨»ï¼Œæ–¹ä¾¿ä¸‹æ¬¡è¼¸å…¥
                document.getElementById('amount').value = '';
                document.getElementById('last5').value = '';
            } else {
                alert("éŒ¯èª¤ï¼š" + data.message);
            }
        })
        .catch(err => {
            loading.style.display = 'none';
            alert("é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            console.error(err);
        });
    });

    // 4. é¡¯ç¤ºçµæœåˆ°ç•«é¢ä¸Š
    function showResult(data) {
        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('resultTitle').innerText = data.name + " çš„å¸³æˆ¶æ¦‚æ³";
        
        const balanceEl = document.getElementById('currentBalance');
        balanceEl.innerText = "$" + data.balance;
        balanceEl.className = data.balance >= 0 ? 'amount-plus' : 'amount-minus';

        const list = document.getElementById('historyList');
        list.innerHTML = ''; // æ¸…ç©ºèˆŠçš„

        data.history.forEach(item => {
            const colorClass = item.amount >= 0 ? 'text-success' : 'text-danger';
            const sign = item.amount >= 0 ? '+' : '';
            
            const li = document.createElement('li');
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
                <div>
                    <strong>${item.date}</strong> <small class="text-muted">(${item.type})</small><br>
                    <small class="text-muted">${item.note}</small>
                </div>
                <span class="${colorClass} fw-bold">${sign}${item.amount}</span>
            `;
            list.appendChild(li);
        });
    }
</script>

</body>
</html>